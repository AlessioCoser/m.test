#!/usr/bin/env sh

set -e

MODULES="../globals"

while [[ $# -gt 0 ]]; do
  flag="$1"
  case $flag in
      help|-h|--help)
        sed '1,8d; $d' $PWD/man/m.test.1\
          | sed -e 's/SYNOPSIS/  Usage:/g'\
          | sed -e 's/OPTIONS/  Options:/g'\
          | sed -e 's/COMMANDS/  Commands:/g'
        exit 0
      ;;
      version|-v|--version)
        node -pe "require('$PWD/package.json').version"
        exit 0
      ;;
      -p|--parallel)
        MAXPROCS="$2"
        shift
      ;;
      -r|--require)
        MODULES="$MODULES $2"
        shift
      ;;
      *)
        PATHS="$PATHS $1"
      ;;
  esac
  shift
done

find ${PATHS:-test} -type f | xargs -n 1 -P ${MAXPROCS:-1} node -r $MODULES
